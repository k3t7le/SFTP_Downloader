# concept.md
## SFTP 기반 파일 수집 시스템 설계 개요

본 문서는 여러 SFTP 서버 디렉터리에서 생성되는 파일들을 안정적으로 다운로드하고,  
로컬 환경의 지정된 폴더로 안전하게 적재하는 **파일 수집 시스템의 설계 개념**을 정리한다.  
특히 장애 시 복구 가능하도록 설계된 `.part → 정상 파일명(rename)` 방식과  
다수의 “잡(Job)”을 설정파일로 유연하게 운영할 수 있는 구조를 중심으로 기술한다.

## 1. 시스템 목적

- SFTP 서버에 지속적으로 생성되는 파일을 **안전하게** 로컬로 가져온다.
- 다운로드 실패, 네트워크 끊김, 장비 장애 등 상황에서도 **데이터 유실 없이 재시도 가능**하게 한다.
- 여러 개의 SFTP 원격 디렉터리를 **잡(Job)** 단위로 묶어,  
  잡별 목적지(local folder)로 정리된 형태로 수집한다.
- 서버 정보·디렉터리 구조·잡별 매핑 등을 **설정파일(appsettings.json)**로 관리하여  
  코드 수정 없이 운영 환경 설정을 변경할 수 있게 한다.

## 2. 기본 동작 개념

1. 설정파일(appsettings.json)에서 서버 정보 및 잡(Job) 정의를 읽는다.  
2. SFTP 서버에 단일 세션으로 접속한다.
3. 각 Job에 대해 다음을 수행한다:
   - Job에 정의된 여러 원격 폴더(RemoteFolders)를 순차적으로 조회
   - 파일 목록을 가져오고, 패턴(`*.dat` 등)에 맞는 파일만 선택
   - 각 파일을 로컬의 대상 폴더(LocalTargetFolder)에 다운로드
   - 다운로드 되는 동안 `.part` 확장자로 임시 저장
   - 다운로드 및 무결성 확인이 끝나면 `.part`를 정상 파일명으로 rename
   - rename 성공 후 원격 파일 삭제 또는 archive 폴더 이동
4. 모든 Job 수행이 끝나면 SFTP 연결을 종료한다.

## 3. `.part → 정상 파일명(rename)` 전략

### 3.1 목적
- 다운로드 중간에 오류가 발생해도 **정상 파일을 오염시키지 않기 위함**
- 프로그램 비정상 종료 시 `.part` 파일만 남기고 재시도할 수 있음
- 재수집 시 `.part` 및 정상 파일 여부만 확인하면 중복 처리 방지 가능

### 3.2 동작 방식
1. 원격 파일을 로컬에서는 항상 `파일명.part` 로 저장한다.
2. 다운로드가 100% 성공하고, 필요하다면 원격 파일 크기/해시와 비교해 무결성 검증을 한다.
3. 검증 성공 시 `.part` 파일을 실제 파일명으로 rename 한다.
4. rename이 완료된 후에만 원격 파일을 삭제하거나 archive로 이동한다.

### 3.3 장점
- 장애 시 정상 파일과 비정상 파일이 명확하게 구분됨  
- 재다운로드 시 누락/중복 문제가 사라짐  
- 리스크가 높은 "부분 다운로드 파일을 정상 파일로 인식" 문제를 방지  

## 4. Job 기반 구분 동작

각 Job은 다음과 같은 요소로 구성된다:

| 항목 | 설명 |
|------|------|
| Name | 잡 이름 |
| RemoteFolders | 해당 잡에서 읽어올 SFTP 경로 목록 |
| LocalTargetFolder | 로컬 저장 폴더 |
| SearchPattern | 파일 필터(예: `*.dat`) |
| DeleteRemoteAfterSuccess | 원격 삭제 여부 |

### 예시

- **AGING_JOB**  
  - 원격 폴더: `/AGING`, `/AGING_TEMP`  
  - 로컬 폴더: `D:\DATA\AGING`

- **CONFIRM_JOB**  
  - 원격 폴더: `/CONFIRM`, `/INIT`  
  - 로컬 폴더: `D:\DATA\CONFIRM`

## 5. 설정 파일 구조(appsettings.json)

### 5.1 SFTP 서버 정보
- Host
- Port
- Username


### 5.2 Jobs 배열
- 여러 개의잡(Job)을 설정 가능
- 각 잡은 서로 다른 폴더 매핑을 가진다

### 5.3 목적
- 운영 환경에 따라 폴더 구조가 변해도 코드 수정 불필요
- Job만 추가하면 시스템 확장 가능

## 6. 장애 대응 전략

1. **정상 파일 존재 시 스킵**  
2. **rename 완료 후에만 원격 삭제**  

## 7. 확장 가능성


## 8. 요약

안전성, 유연성, 운영 편의성을 모두 고려한 구조로  
대량 파일 수집에도 안정적으로 동작할 수 있는 설계이다.

