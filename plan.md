# 개선 계획 (잠재 위험/개선 포인트)

아래 항목은 당장 치명적인 버그가 확인된 것은 아니지만, 현 구조에서 문제를 일으킬 가능성이 있거나 운영 리스크를 줄일 수 있는 개선 사항입니다. 체크 박스는 진행 상태 표시용입니다.

- [ ] **설정 검증 일원화**  
  - 현재 `Configure<AppSettings>`만 사용해 `[Required]/[Range]` 속성이 실제로 강제되지 않습니다. 호스트/계정/포트 같은 필수 값이 빠져도 실행 시점까지 넘어갈 수 있습니다.  
  - `AddOptions<AppSettings>().Bind(...).ValidateDataAnnotations().Validate(...)` 형태로 바인딩과 검증을 묶고, 잡별 `RemoteFolders` 공백/중복, `LocalTargetFolder` 공백/중복 등도 초기 구동 시 예외로 막아야 런타임 실패를 줄일 수 있습니다.

- [ ] **취소 및 예외 가시성 강화**  
  - 원격 폴더 `ListDirectory` 실패 시 로그만 남고 `FolderRunResult`에는 반영되지 않아 요약에서 누락됩니다. 운영자가 실패를 놓칠 수 있습니다.  
  - 대용량 다운로드/압축 중 `CancellationToken`을 더 자주 체크해 Ctrl+C 등 즉시 중단을 제공하고, 폴더 단위 실패/스킵 상태를 결과 객체에도 기록하도록 확장 필요합니다.

- [ ] **다운로드 안전성 향상**  
  - `.part`가 남으면 항상 삭제 후 다시 받습니다. 이전 실행이 거의 끝난 파일을 매번 재다운로드해 시간/트래픽이 낭비될 수 있습니다.  
  - `.part` 크기를 원격 크기와 비교해 부분 완료 시 재개 또는 스킵 전략을 추가하고, 필요 시 해시/크기 검증 옵션(`JobOptions` 확장)으로 무결성 체크를 강화하는 방안이 있습니다.

- [x] **아카이브 처리 안정화**  
  - 압축을 바로 최종 경로에 쓰고 실패 시 삭제만 수행하던 흐름을 임시 워크스페이스(`%TEMP%/sftp-downloader/archive-temp`)에서 `tar.gz.tmp` 생성 → 성공 시만 `ArchiveFolder`로 원자적 이동하도록 변경했습니다.  
  - 임시 폴더에 남은 `.tmp`를 아카이브 시작 시 전량 청소하고, 파일명은 `<Job>_<yyyyMMddHHmmss>.tar.gz`로 단순화했습니다. 다른 프로세스가 `ArchiveFolder`를 감시해도 생성 중 파일이 노출되지 않습니다.

- [ ] **로그/관측성 개선**  
  - 진행률은 `Console.WriteLine`만 사용해 중앙 로그에 남지 않고, 디버그 레벨이라 운영 환경에서 수집되지 않을 수 있습니다.  
  - 진행률·폴더별 성공/실패/소요 시간을 `ILogger`에도 남기고, `JobSummaryPrinter`의 한 줄 요약에 실패 폴더 개수 등 메트릭을 추가하면 장애 파악 속도가 빨라집니다.
